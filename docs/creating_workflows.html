
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Creating workflows &#8212; atomate 0.6.9 documentation</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.6.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Customizing Workflows" href="customizing_workflows.html" />
    <link rel="prev" title="Builders: creating calculation reports for data analysis" href="builders.html" />
 
<link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>

  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="customizing_workflows.html" title="Customizing Workflows"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="builders.html" title="Builders: creating calculation reports for data analysis"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">atomate 0.6.9 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="creating-workflows">
<span id="id1"></span><h1>Creating Workflows<a class="headerlink" href="#creating-workflows" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="running_workflows.html#running-workflows-tutorial"><span class="std std-ref">Running Workflows Tutorial</span></a> walked you through customizing and running a preset VASP workflow from the library of YAML files. While these presets are useful standards for making specific, straightforward calculations, it is often desirable to create your own workflows.</p>
<p>Ideally, custom workflows can be constructed entirely with existing Fireworks. Generally speaking, any workflow that is a series of calculations where only the input files and calculation settings change can be constructed from existing Fireworks. The workflow can have either a simple or complex dependency graph. This guide will explain how to create such custom workflows in Python.</p>
<p>If your desired workflow cannot be created with existing Fireworks, you’ll have to code your own Fireworks. It should be mostly straightforward to do so by looking at the currently implemented Fireworks in atomate and using that as a guide to code your own. For now, we will assume that the Fireworks you need already exist.</p>
</div>
<div class="section" id="objectives">
<h2>Objectives<a class="headerlink" href="#objectives" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Get familiar with the internal structure of Workflows, Fireworks, and Firetasks</li>
<li>Learn to compose atomate Workflows in Python from existing Fireworks</li>
<li>Understand what powerups are and how to use them</li>
<li>Learn how the FireWorker environment can control behavior</li>
</ul>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>In order for you to understand this guide you should</p>
<blockquote>
<div><ul class="simple">
<li>Have a working installation of atomate</li>
<li>Understand how to add Workflows to your FireWorks LaunchPad and run them</li>
<li>Be comfortable with Python functions and classes</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="fireworks-background">
<h2>FireWorks Background<a class="headerlink" href="#fireworks-background" title="Permalink to this headline">¶</a></h2>
<p>All of the machinery for constructing workflows in atomate is from <a class="reference external" href="https://materialsproject.github.io/fireworks/">FireWorks</a>, which is a generalized library for constructing and running workflows. atomate uses the FireWorks library to construct workflows that combine materials science manipulation and analysis implemented in <a class="reference external" href="http://pymatgen.org">pymatgen</a>, database communication from <a class="reference external" href="https://materialsproject.github.io/pymatgen-db/">pymatgen-db</a>, and job running from <a class="reference external" href="https://materialsproject.github.io/custodian/">custodian</a>. The FireWorks documentation provides many excellent tutorials and guides for using and understanding the use of the library, which may be useful.</p>
<p>A FireWorks Workflow is made up of Fireworks, which are made up of Firetasks. The description of each of these is best described by the <a class="reference external" href="https://materialsproject.github.io/fireworks/index.html#workflow-model">FireWorks documentation</a> itself:</p>
<blockquote class="pull-quote">
<div><ul class="simple">
<li>A Workflow is a set of FireWorks with dependencies between them. For example, you might need a parent Firework to finish and generate some output files before running two child FireWorks.</li>
<li>A Firework contains the JSON spec that includes all the information needed to bootstrap your job. For example, the spec contains an array of Firetasks to execute in sequence. The spec also includes any input parameters to pass to your Firetasks. You can easily perform the same function over different input data by creating Fireworks with identical Firetasks but different input parameters in the spec. You can design your spec however you’d like, as long as it’s valid JSON. The JSON format used for Firework specs is extremely flexible, very easy to learn (Python users familiar with dicts and arrays essentially already know JSON), and immediately makes rich searches over the input data available to end users through MongoDB’s JSON document search capabilities.</li>
<li>A Firetask is an atomic computing job. It can call a single shell script or execute a single Python function that you define (either within FireWorks, or in an external package).</li>
</ul>
</div></blockquote>
<p>In atomate, we typically design each Firework to represent one calculation or analysis step. In the example below, a typical bandstructure calculation first optimizes a crystal structure, then performs a static calculation, and finally non-SCF calculations on the band path and uniformly though the structure (which can be executed in parallel since they are not dependent on one another). Each of these calculations (each time you would run VASP) corresponds to a Firework and thus this bandstructure workflow contains 4 Fireworks. One could design this workflow with more or less Fireworks, but in our opinion this is the most natural and useful mapping. For example, note that one Firework most typically corresponds to one queue submission on a supercomputing center (although this can vary depending on the chosen execution mode).</p>
<p>The Firetasks of each Firework are all of the individual steps that are performed for each calculation step. In the example, the structure optimization Firework has tasks to write the VASP input files based on the input structure, run VASP, parse the VASP outputs, and pass the output structure on to the static calculation. For the purposes of this tutorial, you don’t need to worry much about the details of Firetasks, but it helps to appreciate that Fireworks are simply composed of a few of these tasks performed in sequence that allow one to abstract out tedious calculation details like file IO. In the same way, Workflows exist to abstract out the details of different calculation and analysis steps contained in FireWorks.</p>
<div class="figure" id="id3">
<a class="reference internal image-reference" href="_images/bandstructure_wf.png"><img alt="Bandstructure workflow." src="_images/bandstructure_wf.png" style="width: 999.5px; height: 478.0px;" /></a>
<p class="caption"><span class="caption-text">Bandstructure workflow. The Optimize bulk structure Firework is a parent with one child: a Static SCF Firework. The Static SCF Firework has two children: a Static Non-SCF (line) Firework and a Static Non-SCF (uniform) Firework to get the DOS on a path and uniformly, respectively. In terms of execution, the Optimize bulk structure Firework will run the four Firetasks in sequential order with data as described by the spec. Once the Optimize bulk structure Firework and Static SCF Firework complete, the line and uniform SCF Fireworks can be launched and executed in parallel or in series. Since these Fireworks do not depend on each other, the execution order does not matter. Similar to the Optimize structure Firework, all of these Fireworks will run their respective Firetasks in series.</span></p>
</div>
</div>
<div class="section" id="creating-atomate-workflows">
<h2>Creating atomate Workflows<a class="headerlink" href="#creating-atomate-workflows" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sketch-the-workflow">
<h3>Sketch the workflow<a class="headerlink" href="#sketch-the-workflow" title="Permalink to this headline">¶</a></h3>
<p>The first step when you go to write any workflow is to sketch a graph of the workflow. In particular, you want to sketch a <a class="reference external" href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">directed acyclic graph</a>, which for atomate just means that each calculation step is a node in the graph and parents only point to their children such that there are no loops (cycles) in the graph. Again, you should think of each large single invocation of the scientific code (VASP, LAMMPS, etc.) as corresponding to one Firework. Analysis tasks that aggregate results from several Fireworks, e.g. tasks that analyze volume deformations, also need their own Fireworks that have the calculations as parents. All of the workflow examples in the docs and the atomate paper (submitted) are valid workflow graphs.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An advanced method of workflow programming in the FireWorks package allows the workflow to change depending on the results of execution. For example, a Firework can add more Fireworks to the workflow based on results that it obtained. If you need some kind of looping or branching at a high level, you’ll have to write a custom Firetask that creates new Fireworks on the fly. Writing custom Firetasks in atomate may be covered more in depth in a future workflow, but it is beyond the scope of this guide. <a class="reference external" href="https://materialsproject.github.io/fireworks/dynamic_wf_tutorial.html">Fireworks documentation for dynamic workflows</a> discusses this from an abstract perspective.</p>
</div>
</div>
<div class="section" id="finding-fireworks">
<h3>Finding Fireworks<a class="headerlink" href="#finding-fireworks" title="Permalink to this headline">¶</a></h3>
<p>Once you have identified each calculation or analysis step as a Firework in our graph, we must determine which Fireworks correspond to each node in our graph. The full Python documentation for each of the atomate Fireworks can be found in the <a class="reference internal" href="atomate.vasp.fireworks.html#module-atomate.vasp.fireworks" title="atomate.vasp.fireworks"><code class="xref py py-mod docutils literal"><span class="pre">atomate.vasp.fireworks</span> <span class="pre">module</span></code></a> documentation or the corresponding documentation page for the software you want to use. Currently FEFF, LAMMPS, and VASP are supported. Some available VASP Fireworks are</p>
<ul class="simple">
<li>OptimizeFW</li>
<li>StaticFW</li>
<li>TransmuterFW</li>
<li>HSEBSFW</li>
<li>NonSCFFW</li>
<li>LepsFW</li>
<li>SOCFW</li>
<li>MDFW</li>
<li>BoltztrapFW</li>
<li>NEBRelaxationFW</li>
<li>NEBFW</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The majority of these Fireworks are not complicated to run and you can use them directly. Some are less obvious and you should refer to the documentation for the specifics of each of these and how to use them before you do. For example, the HSEBSFW requires a previous calculation that gives VBM/CBM information or the high-symmetry kpoints.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some of these Fireworks only differ in VASP settings or options. For example, a simple OptimizeFW could in principle be customized to achieve the same functionality as several other VASP Fireworks in the same way that two types of burgers at a fast-food restaurant might become equivalent if you customized each order enough.</p>
</div>
<p>One of the main settings to pay attention to, particularly in VASP, is the input set used which determines things like functional, pseudopotential, and convergence settings. The input sets are all defined in pymatgen, such as <a class="reference external" href="http://pymatgen.org/pymatgen.io.vasp.sets.html">pymatgen.io.vasp.sets</a> or <a class="reference external" href="http://pymatgen.org/pymatgen.io.feff.sets.html">pymatgen.io.feff.sets</a>. Most of these are fairly straightforward, but one Firework to pay specific attention to is the TransmuterFW. The TransmuterFW is very powerful because it supports transforming structures by any of the transformations supported in <a class="reference external" href="http://pymatgen.org/pymatgen.transformations.html">pymatgen.transformations</a>. There are many supported transformations in pymatgen, some of the more common transformations include</p>
<ul class="simple">
<li>SupercellTransformation: Create supercells from a scaling matrix</li>
<li>SubstitutionTransformation: Substitute one species for another</li>
<li>PerturbStructureTransformation: Applies a perturbation of a specified amplitude to each site</li>
<li>DeformStructureTransformation: Apply a deformation matrix to the lattice matrix of the structure</li>
</ul>
<p>You’ll notice that more generic Fireworks and Fireworks for analysis tasks are not in this list. Because they are intended to be simple and modular, these Fireworks are actually written as plain Firetasks that will get wrapped into a Firework when the Workflow is constructed. We’ll cover how to use them as Fireworks in the next section, but know that they can be found at places like <a class="reference internal" href="atomate.common.firetasks.html#module-atomate.common.firetasks" title="atomate.common.firetasks"><code class="xref py py-mod docutils literal"><span class="pre">atomate.common.firetasks</span> <span class="pre">module</span></code></a> for software-agnostic tasks such as <code class="docutils literal"><span class="pre">PassCalcLocs</span></code> or <code class="xref py py-mod docutils literal"><span class="pre">atomate.vasp.firetasks</span> <span class="pre">package</span> <span class="pre">&lt;atomate.vasp.firetasks</span></code> for some VASP specific ones, including the analysis tasks usually found in <a class="reference internal" href="atomate.vasp.firetasks.html#module-atomate.vasp.firetasks.parse_outputs" title="atomate.vasp.firetasks.parse_outputs"><code class="xref py py-mod docutils literal"><span class="pre">atomate.vasp.firetasks.parse_outputs</span></code></a>.</p>
</div>
<div class="section" id="creating-the-workflow">
<h3>Creating the workflow<a class="headerlink" href="#creating-the-workflow" title="Permalink to this headline">¶</a></h3>
<p>With each of the Fireworks identified for our sketched workflow, they can assemble them into a complete atomate Workflow in Python. In order to understand what’s going on here, you should be comfortable with creating instances of classes and using functions. To demonstrate how to assemble and use a workflow, we will use a slightly modified version of the Gibbs Free Energy Workflow and step through each line of code to explain what is going on.</p>
<p>For context, the Gibbs Free Energy Workflow calculates <img class="math" src="_images/math/3e8656187474a3145c68b42dfc12efc5115aaa82.png" alt="G(P,T)"/> for a structure. Two methods for doing this are using the Debye model (see <a class="reference external" href="http://dx.doi.org/10.1016/j.comphy.2003.12.001">Blanco et al. Comput. Phys. Commun., 158, (2004)</a>) or through vibration frequencies of atoms (see <a class="reference external" href="http://dx.doi.org/10.1016/j.scriptamat.2015.07.021">Togo and Tanaka, Scr. Mater., 108 (2015)</a>. It does this by first optimizing the desired structure. Next, that optimized structure has its volume scaled and a VASP calculation that is either a static calculation or calculation with density functional perturbation theory (the <code class="docutils literal"><span class="pre">IBRION</span> <span class="pre">=</span> <span class="pre">7</span> <span class="pre">or</span> <span class="pre">8</span></code> INCAR setting) is performed depending on what type of analysis is used. In the analysis, the Debye model or a phonon calculation is used to extrapolate the from 0K to finite temperatures using the harmonic approximation, giving each structure an <img class="math" src="_images/math/88aec2489da0734cf63c2dd134a1f82301d7edac.png" alt="F(T)"/> dependence. Then each of these structures are considered together and fit to an equation of state which allows us express <img class="math" src="_images/math/ed2a0cbdcad2bc864a89ae8e66bd25d60f55957d.png" alt="F(V,T)"/> for this structure, which we can transform to <img class="math" src="_images/math/3e8656187474a3145c68b42dfc12efc5115aaa82.png" alt="G(P,T)"/> to get the Gibbs free energy of that structure. The phonopy website has a <a class="reference external" href="https://atztogo.github.io/phonopy/qha.html#phonopy-qha">good visualization for Helmholtz energies and volumes with increasing temperature</a>.</p>
<p>The Python implementation of the modified Gibbs Free Energy Workflow is:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.elasticity.strain</span> <span class="kn">import</span> <span class="n">Deformation</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.vasp.sets</span> <span class="kn">import</span> <span class="n">MPRelaxSet</span><span class="p">,</span> <span class="n">MPStaticSet</span>
<span class="kn">from</span> <span class="nn">fireworks</span> <span class="kn">import</span> <span class="n">Firework</span><span class="p">,</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">atomate.vasp.fireworks.core</span> <span class="kn">import</span> <span class="n">OptimizeFW</span><span class="p">,</span> <span class="n">TransmuterFW</span>
<span class="kn">from</span> <span class="nn">atomate.vasp.firetasks.parse_outputs</span> <span class="kn">import</span> <span class="n">GibbsFreeEnergyTask</span>


<span class="k">def</span> <span class="nf">wf_gibbs_free_energy</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">deformations</span><span class="p">,</span> <span class="n">vasp_input_set_relax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vasp_input_set_static</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vasp_cmd</span><span class="o">=</span><span class="s2">&quot;vasp&quot;</span><span class="p">,</span>
                             <span class="n">db_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">user_kpoints_settings</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">t_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">t_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                             <span class="n">mesh</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">eos</span><span class="o">=</span><span class="s2">&quot;vinet&quot;</span><span class="p">,</span> <span class="n">qha_type</span><span class="o">=</span><span class="s2">&quot;debye_model&quot;</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">poisson</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns quasi-harmonic gibbs free energy workflow.</span>
<span class="sd">    Note: phonopy package is required for the final analysis step if qha_type=&quot;phonopy&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        structure (Structure): input structure.</span>
<span class="sd">        deformations (list): list of deformation matrices(list of lists).</span>
<span class="sd">        vasp_input_set_relax (VaspInputSet)</span>
<span class="sd">        vasp_input_set_static (VaspInputSet)</span>
<span class="sd">        vasp_cmd (str): vasp command to run.</span>
<span class="sd">        db_file (str): path to the db file.</span>
<span class="sd">        user_kpoints_settings (dict): example: {&quot;grid_density&quot;: 7000}</span>
<span class="sd">        t_step (float): temperature step (in K)</span>
<span class="sd">        t_min (float): min temperature (in K)</span>
<span class="sd">        t_max (float): max temperature (in K)</span>
<span class="sd">        mesh (list/tuple): reciprocal space density</span>
<span class="sd">        eos (str): equation of state used for fitting the energies and the volumes.</span>
<span class="sd">            options supported by phonopy: &quot;vinet&quot;, &quot;murnaghan&quot;, &quot;birch_murnaghan&quot;.</span>
<span class="sd">            Note: pymatgen supports more options than phonopy. see pymatgen.analysis.eos.py</span>
<span class="sd">        qha_type(str): quasi-harmonic approximation type: &quot;debye_model&quot; or &quot;phonopy&quot;,</span>
<span class="sd">            default is &quot;debye_model&quot;</span>
<span class="sd">        pressure (float): in GPa</span>
<span class="sd">        poisson (float): poisson ratio</span>
<span class="sd">    Returns:</span>
<span class="sd">        Workflow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">-%H-%M-%S-</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># get the input set for the optimization and update it if we passed custom settings</span>
    <span class="n">vis_relax</span> <span class="o">=</span> <span class="n">vasp_input_set</span> <span class="ow">or</span> <span class="n">MPRelaxSet</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">force_gamma</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_kpoints_settings</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vis_relax</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;user_kpoints_settings&quot;</span><span class="p">:</span> <span class="n">user_kpoints_settings</span><span class="p">})</span>
        <span class="n">vis_relax</span> <span class="o">=</span> <span class="n">vis_relax</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># Structure optimization firework</span>
    <span class="n">fws</span> <span class="o">=</span> <span class="p">[</span><span class="n">OptimizeFW</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">vasp_input_set</span><span class="o">=</span><span class="n">vis_relax</span><span class="p">,</span> <span class="n">vasp_cmd</span><span class="o">=</span><span class="n">vasp_cmd</span><span class="p">,</span>
                      <span class="n">db_file</span><span class="o">=</span><span class="n">db_file</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;{} structure optimization&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))]</span>

    <span class="c1"># get the input set for the static calculations and update it if we passed custom settings</span>
    <span class="n">uis_static</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ISIF&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ISTART&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">lepsilon</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># use IBRION = -1; don&#39;t update the ions</span>
    <span class="k">if</span> <span class="n">qha_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;debye model&#39;</span><span class="p">]:</span>
        <span class="n">uis_static</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ISIF&#39;</span><span class="p">}</span>
        <span class="n">lepsilon</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># use IBRION = -8; DFPT</span>
    <span class="n">vis_static</span> <span class="o">=</span> <span class="n">MPStaticSet</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">force_gamma</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">lepsilon</span><span class="o">=</span><span class="n">lepsilon</span><span class="p">,</span>
                         <span class="n">user_kpoints_settings</span><span class="o">=</span><span class="n">user_kpoints_settings</span><span class="p">,</span>
                         <span class="n">user_incar_settings</span><span class="o">=</span><span class="n">uis_static</span><span class="p">)</span>

    <span class="c1"># create each deformation Firework and add them to the Fireworks list</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="n">fws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">deformations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Deformation</span><span class="p">(</span><span class="n">defo_mat</span><span class="p">)</span> <span class="k">for</span> <span class="n">defo_mat</span> <span class="ow">in</span> <span class="n">deformations</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">deformation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deformations</span><span class="p">):</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">TransmuterFW</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;{} {} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s1">&#39;gibbs deformation&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
                          <span class="n">transformations</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DeformStructureTransformation&#39;</span><span class="p">],</span>
                          <span class="n">transformation_params</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;deformation&quot;</span><span class="p">:</span> <span class="n">deformation</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}],</span>
                          <span class="n">vasp_input_set</span><span class="o">=</span><span class="n">vis_static</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span>
                          <span class="n">vasp_cmd</span><span class="o">=</span><span class="n">vasp_cmd</span><span class="p">,</span> <span class="n">db_file</span><span class="o">=</span><span class="n">db_file</span><span class="p">)</span>
        <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

    <span class="n">parents</span> <span class="o">=</span> <span class="n">fws</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># all of the deformation Fireworks</span>
    <span class="k">if</span> <span class="n">qha_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;debye_model&quot;</span><span class="p">]:</span>
        <span class="kn">from</span> <span class="nn">phonopy</span> <span class="kn">import</span> <span class="n">Phonopy</span>
    <span class="n">fw_analysis</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">GibbsFreeEnergyTask</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">db_file</span><span class="o">=</span><span class="n">db_file</span><span class="p">,</span> <span class="n">t_step</span><span class="o">=</span><span class="n">t_step</span><span class="p">,</span> <span class="n">t_min</span><span class="o">=</span><span class="n">t_min</span><span class="p">,</span>
                                               <span class="n">t_max</span><span class="o">=</span><span class="n">t_max</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">eos</span><span class="o">=</span><span class="n">eos</span><span class="p">,</span> <span class="n">qha_type</span><span class="o">=</span><span class="n">qha_type</span><span class="p">,</span>
                                               <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span> <span class="n">poisson</span><span class="o">=</span><span class="n">poisson</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gibbs free energy&quot;</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="n">parents</span><span class="p">)</span>
    <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw_analysis</span><span class="p">)</span>

    <span class="c1"># finally, create the workflow</span>
    <span class="n">wf_gibbs</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fws</span><span class="p">)</span>
    <span class="n">wf_gibbs</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;{}:{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span><span class="p">,</span> <span class="s2">&quot;gibbs free energy&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wf_gibbs</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The documentation and source for the actual Gibbs Free Energy Workflow is found at <a class="reference internal" href="atomate.vasp.workflows.base.html#module-atomate.vasp.workflows.base.gibbs" title="atomate.vasp.workflows.base.gibbs"><code class="xref py py-mod docutils literal"><span class="pre">atomate.vasp.workflows.base.gibbs</span></code></a>. Here we have simplified some of the options and explicitly added each Firework.</p>
</div>
<p>In the above code example, we start by importing the classes and functions we’ll be using and defining our <code class="docutils literal"><span class="pre">wf_gibbs_free_energy</span></code> function with all of the parameters we’d like to control from a workflow level and the documentation for those parameters. Running the function will return a FireWorks Workflow to add to the LaunchPad.</p>
<p>Lines 41-51 is where we define the optimization Firework. First we check if a vasp_input_set_relax parameter was passed, if not we default to MPRelaxSet and update that set if the <code class="docutils literal"><span class="pre">user_kpoints_settings</span></code> parameter was passed. It’s common to see a similar parameter for <code class="docutils literal"><span class="pre">user_incar_settings</span></code>. On line 49 we create our list of Fireworks (<code class="docutils literal"><span class="pre">fws</span></code>) with the <code class="docutils literal"><span class="pre">OptimizeFW</span></code> that we imported. Take note that this is the only Firework we pass our structure to, which allows for more flexibility. More on this later.</p>
<p>Lines 52-61 we do a similar thing with the <code class="docutils literal"><span class="pre">MPStaticSet</span></code> from pymatgen that we did for the <code class="docutils literal"><span class="pre">MPRelaxSet</span></code>. Then in lines 63-71, we loop through each of the deformations passed (as a list of 2-dimensional lists describing deformation matricies) and instantiate <code class="docutils literal"><span class="pre">TransmuterFW</span></code> with that deformation as the <code class="docutils literal"><span class="pre">transformation_params</span></code>. For each type of transformation you use (<code class="docutils literal"><span class="pre">DeformStructureTransformation</span></code>) here, you will need to look at what parameters that class takes and use the right keyword, which is <code class="docutils literal"><span class="pre">deformation</span></code> in this case. Another example is the <code class="docutils literal"><span class="pre">SupercellTransformation</span></code> takes a transformation parameter called <code class="docutils literal"><span class="pre">scale</span></code>. Pay close attention that on line 69 we are adding the <code class="docutils literal"><span class="pre">OptimizeFW</span></code> (from <code class="docutils literal"><span class="pre">fws[0]</span></code>) as the parent for all of these Fireworks so they can run in parallel.</p>
<p>Next on lines 73-76 we taking a <em>Firetask</em> and wrapping it in a pure Firework object from FireWorks. This demonstrates the modularity and customizability that FireWorks allows, which favors composing existing objects over writing custom ones for each level of abstraction. We are passing the same sort of parameters to this Firetask that we have been passing, which allows you to correctly infer that Fireworks themselves propogate relevant parameters down to their Firetasks. Again, we are setting the parents of this analysis Firework to all of the Fireworks in our list except the first one (the <code class="docutils literal"><span class="pre">OptimizeFW</span></code>). This ensure that the analysis does not run until <em>all</em> of our transformed structures have finished running.</p>
<p>Finally we use a vanilla FireWorks <code class="docutils literal"><span class="pre">Workflow</span></code> object to pull in all our Fireworks, update the name of the Workflow and return the object. From here you can write a script similar to the <a class="reference internal" href="running_workflows.html#running-workflows-tutorial"><span class="std std-ref">Running Workflows Tutorial</span></a> and pass in the correct variables to get a workflow to add to the LaunchPad. In this workflow, pay attention to the <code class="docutils literal"><span class="pre">vasp_cmd</span></code> parameter and <code class="docutils literal"><span class="pre">db_file</span></code> parameters to get the correct behavior. The preset workers will default these to your FireWorker’s environment variables, but you will have to handle that manually here. To use your environment variables, pass in <code class="docutils literal"><span class="pre">'&gt;&gt;vasp_cmd&lt;&lt;'</span></code> and <code class="docutils literal"><span class="pre">'&gt;&gt;db_file&lt;&lt;'</span></code> for each of these parameters, respectively. More on this behavior in the <a class="reference internal" href="#env-chk">env_chk</a> section.</p>
</div>
<div class="section" id="more-help">
<h3>More help<a class="headerlink" href="#more-help" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Reading the source the base Workflows (<a class="reference internal" href="atomate.vasp.workflows.base.html#module-atomate.vasp.workflows.base" title="atomate.vasp.workflows.base"><code class="xref py py-mod docutils literal"><span class="pre">atomate.vasp.workflows.base</span></code></a>) would be a good place to find functional examples with reasonable parameters</li>
<li>Creating workflows can also be done to some extent in YAML files. You can adapt the example along with a short explanation of the <a class="reference internal" href="workflow_yaml_reference.html#workflow-yaml-reference"><span class="std std-ref">Workflow YAML Reference</span></a>.</li>
</ul>
</div>
</div>
<div class="section" id="modifying-workflows">
<h2>Modifying workflows<a class="headerlink" href="#modifying-workflows" title="Permalink to this headline">¶</a></h2>
<p>There are a few other interesting features of workflows in atomate that make writing dynamic and customizable workflows easier.</p>
<div class="section" id="powerups">
<h3>Powerups<a class="headerlink" href="#powerups" title="Permalink to this headline">¶</a></h3>
<p>Powerups (<a class="reference internal" href="atomate.vasp.html#module-atomate.vasp.powerups" title="atomate.vasp.powerups"><code class="xref py py-mod docutils literal"><span class="pre">atomate.vasp.powerups</span></code></a>) enable modifications to be made to workflows <strong>after</strong> they have been created. The benefit of these is that you can apply powerups conditionally in code or to a large list of Workflows that you’ll later add to your LaunchPad. Some powerups affect the behavior of your calculations, others simply add metadata or change how the individual Fireworks interact with the database under the hood.</p>
<p>Some useful powerups that affect the behavior of VASP are</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">add_modify_incar</span></code>: Update the INCAR of Fireworks specifed by (partially matched) name at runtime</li>
<li><code class="docutils literal"><span class="pre">set_fworker</span></code>: specify certain FireWorkers for workflows. Useful for FireWorkers tuned for high-memory or high-precision jobs</li>
<li><code class="docutils literal"><span class="pre">modify_to_soc</span></code>: makes all of the VASP calculations that match the constraints take spin orbit coupling into account</li>
<li><code class="docutils literal"><span class="pre">remove_custodian</span></code>, <code class="docutils literal"><span class="pre">use_custodian</span></code>, <code class="docutils literal"><span class="pre">run_fake_vasp</span></code>: Choose to run VASP with or without custodian (or not at all, useful for debugging)</li>
</ul>
<p>Powerups that modify how FireWorks runs and can interact with workflows as they run</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">add_priority</span></code>: adds priority to root and child jobs to ensure that calculations that start have priority to finish over unstarted Fireworks</li>
<li><code class="docutils literal"><span class="pre">add_namefile</span></code>: put a <code class="docutils literal"><span class="pre">FW--&gt;&gt;fw.name&lt;&lt;</span></code> file in the launch directory so searching filesystems for particular Fireworks is easy.</li>
<li><code class="docutils literal"><span class="pre">add_trackers</span></code>: Fireworks will report the last few lines of OUTCAR and OSZICAR files that can be used to track jobs as they are still running</li>
<li><code class="docutils literal"><span class="pre">add_wf_metadata</span></code> and <code class="docutils literal"><span class="pre">add_tags</span></code>: add metadata to workflows for easier querying</li>
<li><code class="docutils literal"><span class="pre">add_stability_check</span></code> and <code class="docutils literal"><span class="pre">add_bandgap_check</span></code>: end workflows if the calculated structure has much lower energy than a materialsproject.org structure or if the bandgap is above or below a certain threshold</li>
</ul>
</div>
<div class="section" id="env-chk">
<span id="id2"></span><h3>env_chk<a class="headerlink" href="#env-chk" title="Permalink to this headline">¶</a></h3>
<p>Workflows in atomate are powerful for getting science done quickly because they are designed to be easily run heterogenously on different computing resources. <code class="docutils literal"><span class="pre">env_chk</span></code> enables this functionality by letting the user specify parameters that support <code class="docutils literal"><span class="pre">env_chk</span></code>, such as <code class="docutils literal"><span class="pre">db_file</span></code>, <code class="docutils literal"><span class="pre">vasp_cmd</span></code>, and <code class="docutils literal"><span class="pre">incar_update</span></code>. These allow different resources (or simply different <code class="docutils literal"><span class="pre">my_fworker.yaml</span></code> files on the same compute resource) to have settings specific to workflows that they run. Some ideas for using <code class="docutils literal"><span class="pre">env_chk</span></code> like this are</p>
<ul class="simple">
<li>Be able to quickly switch between different database files that are associated with different research projects</li>
<li>Ensure more consistent and easier usage of INCAR parameters you use often, such as setting a high <code class="docutils literal"><span class="pre">NEDOS</span></code> INCAR parameter</li>
<li>Set FireWorkers up for low and high precision jobs, or normal and high-memory jobs on the same computing resource.</li>
</ul>
<p>To use <code class="docutils literal"><span class="pre">env_chk</span></code>, you don’t have to do anything explicity, just pass <code class="docutils literal"><span class="pre">'&gt;&gt;db_file&lt;&lt;'</span></code>, <code class="docutils literal"><span class="pre">'&gt;&gt;vasp_cmd&lt;&lt;'</span></code>, <code class="docutils literal"><span class="pre">'&gt;&gt;incar_update&lt;&lt;'</span></code> to any parameter that supports <code class="docutils literal"><span class="pre">env_chk</span></code>.</p>
<p>Currently supported <code class="docutils literal"><span class="pre">env_chk</span></code> variables are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&gt;&gt;scratch_dir&lt;&lt;</span></code></li>
<li><code class="docutils literal"><span class="pre">&gt;&gt;gamma_vasp_cmd&lt;&lt;</span></code></li>
<li><code class="docutils literal"><span class="pre">&gt;&gt;vasp_cmd&lt;&lt;</span></code></li>
<li><code class="docutils literal"><span class="pre">&gt;&gt;db_file&lt;&lt;</span></code></li>
</ul>
<p>If you think there are other potentially useful variables that should support <code class="docutils literal"><span class="pre">env_chk</span></code>, please propose your idea in the <a class="reference external" href="https://groups.google.com/forum/#!forum/atomate">atomate Google Group</a> (or better, submit a pull request)!</p>
</div>
<div class="section" id="passcalclocs">
<h3>PassCalcLocs<a class="headerlink" href="#passcalclocs" title="Permalink to this headline">¶</a></h3>
<p>In order to be able to act on and modify the initial structure as it changes throughout workflows, there needed to be a way to refer to previous calculations that without hard coding file paths or by meticululously keeping track of paths throughout Firetasks and Fireworks. <code class="docutils literal"><span class="pre">PassCalcLocs</span></code> (<a class="reference internal" href="atomate.common.firetasks.html#module-atomate.common.firetasks.glue_tasks" title="atomate.common.firetasks.glue_tasks"><code class="xref py py-mod docutils literal"><span class="pre">atomate.common.firetasks.glue_tasks</span></code></a>) solves this problem by easily tracking previous calculation directories and making them available to consecutive Fireworks, even between different computing resources. <code class="docutils literal"><span class="pre">PassCalcLocs</span></code> enables Fireworks to be dynamically added and removed from workflows during runtime, enabling features such as branching during the calculation. Such branching could be used by having different workflow steps for handing metals and non-metals.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>Understanding this guide has enabled you to create arbitrarily complex atomate workflows with any combination of Firetasks and Fireworks, but not everything was able to be covered in detail with examples. See the <a class="reference internal" href="customizing_workflows.html#customizing-workflows"><span class="std std-ref">Customizing Workflows</span></a> documentation for specific examples for customizing workflows that you can adapt to your needs.</p>
<p>If any of this was unclear, or if you feel that useful documentation is missing, please leave us feedback on the <a class="reference external" href="https://groups.google.com/forum/#!forum/atomate">atomate Google Group</a>! To see all of the different pieces you can control with Python, go to the <a class="reference internal" href="py-modindex.html"><span class="std std-ref">API documentation</span></a>. Many customization options and features of interest are not in atomate alone, but in <a class="reference external" href="https://materialsproject.github.io/fireworks/">FireWorks</a>, <a class="reference external" href="http://pymatgen.org">pymatgen</a>, and <a class="reference external" href="https://materialsproject.github.io/custodian/">custodian</a>. Mastering FireWorks will enable you to get the most out of executing and managing your workflows. Mastering pymatgen will help you write complex materials workflows and perform sophisticated analyses of results.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Creating Workflows</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#objectives">Objectives</a></li>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#fireworks-background">FireWorks Background</a></li>
<li><a class="reference internal" href="#creating-atomate-workflows">Creating atomate Workflows</a><ul>
<li><a class="reference internal" href="#sketch-the-workflow">Sketch the workflow</a></li>
<li><a class="reference internal" href="#finding-fireworks">Finding Fireworks</a></li>
<li><a class="reference internal" href="#creating-the-workflow">Creating the workflow</a></li>
<li><a class="reference internal" href="#more-help">More help</a></li>
</ul>
</li>
<li><a class="reference internal" href="#modifying-workflows">Modifying workflows</a><ul>
<li><a class="reference internal" href="#powerups">Powerups</a></li>
<li><a class="reference internal" href="#env-chk">env_chk</a></li>
<li><a class="reference internal" href="#passcalclocs">PassCalcLocs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="builders.html"
                        title="previous chapter">Builders: creating calculation reports for data analysis</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="customizing_workflows.html"
                        title="next chapter">Customizing Workflows</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/creating_workflows.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="customizing_workflows.html" title="Customizing Workflows"
             >next</a> |</li>
        <li class="right" >
          <a href="builders.html" title="Builders: creating calculation reports for data analysis"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">atomate 0.6.9 documentation</a> &#187;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Anubhav Jain.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>

  </body>
</html>